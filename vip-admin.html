<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>VIP Admin | OFF Company</title>

<style>
  @font-face{
    font-family:"Rokiest";
    src:url("https://waycompanygg.github.io/roteiro/assets/fonts/Rokiest-Extrabold.otf") format("opentype");
    font-weight:800; font-display:swap;
  }
  :root{
    --bg1:#060812; --bg2:#0b1220;
    --panel:rgba(10,16,28,.78);
    --stroke:rgba(255,255,255,.10);
    --text:#e5e7eb; --muted:rgba(229,231,235,.62);
    --blue:#2563eb; --green:#22c55e; --red:#ef4444; --amber:#f59e0b; --cyan:#06b6d4; --purple:#8b5cf6;
    --shadow:0 24px 80px rgba(0,0,0,.68);
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text);
    background:
      radial-gradient(900px 520px at 14% 12%, rgba(139,92,246,.18), transparent 60%),
      radial-gradient(900px 520px at 86% 18%, rgba(6,182,212,.14), transparent 60%),
      radial-gradient(900px 520px at 70% 90%, rgba(34,197,94,.12), transparent 60%),
      linear-gradient(135deg,var(--bg1),var(--bg2));
    display:flex; justify-content:center;
    padding:22px;
  }

  .home{
    position:fixed; top:16px; left:16px;
    background:rgba(17,24,39,.92);
    border:1px solid rgba(255,255,255,.12);
    color:#fff; text-decoration:none;
    font-weight:900; font-size:14px;
    padding:10px 12px;
    border-radius:12px;
    box-shadow:0 12px 30px rgba(0,0,0,.45);
    transition:.15s;
    z-index:10;
  }
  .home:hover{transform:translateY(-1px); opacity:.92}

  .wrap{
    width:min(1200px,100%);
    background:var(--panel);
    border:1px solid var(--stroke);
    border-radius:24px;
    box-shadow:var(--shadow);
    padding:18px;
    backdrop-filter:blur(10px);
    animation: in .45s ease both;

    <div class="card" style="margin-top:12px; border-color: rgba(239,68,68,.28); background: rgba(239,68,68,.06);">
  <div class="cardTitle" style="display:flex; align-items:center; gap:10px;">
    <span style="filter:drop-shadow(0 10px 22px rgba(239,68,68,.22));">‚ö†Ô∏è</span>
    Zona perigosa
  </div>
  <div class="sub" style="margin-top:6px;">
    Isso apaga <b>TODOS</b> os c√≥digos e <b>TODOS</b> os slots da planilha (VIP e CODES). N√£o tem desfazer.
  </div>

  <div class="row" style="margin-top:10px;">
    <div class="field" style="flex:0 0 260px;">
      <label>Recriar Pool ap√≥s apagar (0 = n√£o)</label>
      <input id="wipePool" type="number" min="0" value="50">
    </div>

    <button class="danger" onclick="wipeAll()" style="flex:0 0 220px;">
      üß® APAGAR TUDO
    </button>
  </div>

  <div class="sub" style="margin-top:10px; opacity:.85">
    Dica: se quiser s√≥ ‚Äúzerar‚Äù um c√≥digo espec√≠fico, use as a√ß√µes normais. Esse bot√£o √© reset total.
  </div>
</div>

    
  }
  @keyframes in{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

  .topbar{
    display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
    align-items:flex-end;
    padding:6px 6px 14px;
  }
  h1{font-family:"Rokiest"; margin:0; letter-spacing:.9px; font-size:34px}
  .sub{margin:6px 0 0; color:var(--muted); font-size:13px}
  .brand{
    display:flex; flex-direction:column; align-items:flex-end;
    gap:6px;
  }
  .pill{
    display:inline-flex; gap:8px; align-items:center;
    padding:8px 10px;
    border:1px solid rgba(255,255,255,.10);
    border-radius:999px;
    background:rgba(255,255,255,.04);
    color:rgba(229,231,235,.72);
    font-size:12px; font-weight:900;
  }

  .grid2{
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap:12px;
  }
  @media(max-width:980px){ .grid2{grid-template-columns:1fr} }

  .card{
    background:rgba(255,255,255,.04);
    border:1px solid var(--stroke);
    border-radius:18px;
    padding:14px;
  }
  .cardTitle{
    font-family:"Rokiest";
    letter-spacing:.6px;
    font-size:18px;
    margin:0 0 10px;
  }

  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end}
  .field{display:flex; flex-direction:column; gap:6px; flex:1 1 220px}
  label{font-size:12px; color:rgba(229,231,235,.72)}
  input, select{
    height:44px; border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(2,6,23,.55);
    color:var(--text);
    padding:10px 12px;
    outline:none;
    transition:.15s;
  }
  input:focus, select:focus{
    border-color: rgba(139,92,246,.55);
    box-shadow: 0 0 0 4px rgba(139,92,246,.18);
  }

  button{
    height:44px; border-radius:12px; border:0;
    padding:0 14px; font-weight:900;
    cursor:pointer; color:#fff;
    transition:.15s;
    white-space:nowrap;
  }
  button:hover{transform:translateY(-1px); opacity:.95}
  button:active{transform:translateY(0); opacity:.9}
  .b{background:linear-gradient(135deg, rgba(139,92,246,.95), rgba(6,182,212,.65)); box-shadow:0 10px 26px rgba(139,92,246,.20)}
  .g{background:rgba(34,197,94,.22); border:1px solid rgba(34,197,94,.35)}
  .a{background:rgba(245,158,11,.25); border:1px solid rgba(245,158,11,.35); color:#111827}
  .ghost{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10)}
  .danger{background:rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.35)}

  .divider{height:1px; background:rgba(255,255,255,.08); margin:12px 0}

  .kpis{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:10px;
    margin-top:10px;
  }
  .kpi{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(2,6,23,.35);
    border-radius:16px;
    padding:12px;
  }
  .kpi .t{font-size:12px; color:rgba(229,231,235,.65); font-weight:900}
  .kpi .v{font-size:22px; font-weight:900; margin-top:6px}
  @media(max-width:980px){ .kpis{grid-template-columns:1fr 1fr} }
  @media(max-width:560px){ .kpis{grid-template-columns:1fr} }

  .slotsHeader{
    display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    align-items:center;
    margin-top:12px;
  }
  .slotsHeader .hint{color:rgba(229,231,235,.62); font-size:12px}

  .slotsGrid{
    display:grid;
    grid-template-columns: repeat(6, 1fr);
    gap:10px;
    margin-top:12px;
  }
  @media(max-width:980px){ .slotsGrid{grid-template-columns: repeat(3, 1fr);} }
  @media(max-width:560px){ .slotsGrid{grid-template-columns: repeat(2, 1fr);} }

  .slot{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(2,6,23,.45);
    border-radius:16px;
    padding:12px;
    transition:.15s;
    min-height: 150px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .slot:hover{transform:translateY(-1px); opacity:.98}
  .topRow{display:flex; justify-content:space-between; align-items:center; gap:8px}
  .num{font-weight:900; color:rgba(229,231,235,.92)}
  .badge{
    font-size:12px; font-weight:900;
    padding:6px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.04);
  }
  .bLivre{ border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.08); }
  .bOcup{ border-color: rgba(245,158,11,.22); background: rgba(245,158,11,.08); }
  .bBloq{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.08); }
  .bConf{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.16); }

  .info{ margin-top:8px; font-size:12px; color: rgba(229,231,235,.78); line-height:1.25; }
  .muted{color: rgba(229,231,235,.55)}

  .miniActions{display:flex; gap:8px; margin-top:10px;}
  .miniBtn{
    flex:1 1 auto;
    height:34px;
    border-radius:10px;
    padding:0;
    font-weight:900;
    font-size:13px;
  }
  .miniBlue{ background:rgba(37,99,235,.22); border:1px solid rgba(37,99,235,.35); }
  .miniGreen{ background:rgba(34,197,94,.20); border:1px solid rgba(34,197,94,.38); }
  .miniRed{ background:rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.35); }

  .overlay{
    position:fixed; inset:0;
    display:none;
    align-items:center; justify-content:center;
    background:rgba(0,0,0,.55);
    backdrop-filter:blur(10px);
    z-index:99999;
    padding:18px;
  }
  .modal{
    width:min(820px, 96vw);
    border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(11,18,32,.92);
    box-shadow:0 20px 70px rgba(0,0,0,.70);
    padding:14px;
    animation: pop .22s ease both;
  }
  @keyframes pop{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
  .ring{
    width:56px; height:56px;
    border-radius:999px;
    border:3px solid rgba(255,255,255,.18);
    border-top-color:rgba(139,92,246,.95);
    margin:10px auto 12px;
    animation:spin .9s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  .toast{
    position:fixed; bottom:18px; left:50%;
    transform:translateX(-50%);
    background:rgba(17,24,39,.95);
    border:1px solid rgba(255,255,255,.12);
    padding:10px 12px;
    border-radius:12px;
    font-weight:900;
    opacity:0; pointer-events:none;
    transition:.2s;
    z-index: 999999;
    box-shadow:0 12px 30px rgba(0,0,0,.45);
    max-width:min(92vw, 860px);
    text-align:center;
  }
  .toast.show{opacity:1}

  .table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    overflow:hidden;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(2,6,23,.35);
  }
  .table th,.table td{
    padding:10px 10px;
    font-size:12px;
    border-bottom:1px solid rgba(255,255,255,.06);
    color: rgba(229,231,235,.85);
    text-align:left;
  }
  .table th{
    font-size:12px;
    color: rgba(229,231,235,.65);
    font-weight:900;
    background: rgba(255,255,255,.03);
  }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    font-weight:900;
    font-size:12px;
    white-space:nowrap;
  }
  .chipPurple{ border-color: rgba(139,92,246,.30); background: rgba(139,92,246,.12); }
  .footer{
    margin-top:14px;
    padding:10px 6px 0;
    color:rgba(229,231,235,.55);
    font-size:12px;
    display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
</style>
</head>

<body>
<a class="home" href="index.html">üè† Home</a>

<!-- LOADER -->
<div id="overlay" class="overlay">
  <div class="modal" style="width:min(520px,96vw); text-align:center">
    <div class="ring"></div>
    <div style="font-family:Rokiest;letter-spacing:.6px;font-size:22px;">Processando‚Ä¶</div>
    <div style="margin-top:6px;color:rgba(229,231,235,.7);font-size:13px;">Aguarde</div>
  </div>
</div>

<!-- MODAL RESUMO -->
<div id="summaryModal" class="overlay">
  <div class="modal">
    <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
      <div style="font-family:Rokiest; letter-spacing:.6px; font-size:18px;">Resumo de Slots (Ocupados / Livres)</div>
      <button class="ghost" style="height:40px" onclick="closeSummary()">‚úï</button>
    </div>

    <div class="divider"></div>

    <div class="kpis">
      <div class="kpi"><div class="t">Total</div><div class="v" id="mTotal">0</div><div class="sub" style="margin:2px 0 0">geral</div></div>
      <div class="kpi"><div class="t">Livres</div><div class="v" id="mFree">0</div><div class="sub" style="margin:2px 0 0">dispon√≠veis</div></div>
      <div class="kpi"><div class="t">Ocupados</div><div class="v" id="mTaken">0</div><div class="sub" style="margin:2px 0 0">reservados</div></div>
      <div class="kpi"><div class="t">Confirmados</div><div class="v" id="mConf">0</div><div class="sub" style="margin:2px 0 0">VIP ok</div></div>
    </div>

    <div class="divider"></div>

    <table class="table">
      <thead>
        <tr>
          <th>#Slot</th>
          <th>Status</th>
          <th>Nome</th>
          <th>C√≥digo</th>
        </tr>
      </thead>
      <tbody id="mRows"></tbody>
    </table>

    <div class="sub" style="margin-top:10px">Mostra apenas ocupados/confirmados com o c√≥digo vinculado.</div>
  </div>
</div>

<div class="wrap">
  <div class="topbar">
    <div>
      <h1>VIP Admin</h1>
      <div class="sub">OFF Company ‚Ä¢ Pool + C√≥digos + Slots</div>
    </div>
    <div class="brand">
      <div class="pill">üîí √Årea restrita ‚Ä¢ Admin</div>
      <div class="pill">‚öôÔ∏è Desenvolvido por Lucas Santos</div>
    </div>
  </div>

  <div class="grid2">
    <!-- POOL -->
    <div class="card">
      <div class="cardTitle">Pool (Slots gerais)</div>
      <div class="sub">Crie/ajuste a capacidade total e j√° mostre os slots automaticamente.</div>

      <div class="row" style="margin-top:10px;">
        <div class="field">
          <label>Senha Admin</label>
          <input id="adminPass" type="password" placeholder="Sua senha admin">
        </div>
        <div class="field" style="flex:0 0 220px;">
          <label>Total de slots no Pool</label>
          <input id="poolTotal" type="number" min="0" value="50">
        </div>
        <button class="b" onclick="setPool()">Aplicar Pool</button>
      </div>

      <div class="divider"></div>

      <div class="kpis">
        <div class="kpi"><div class="t">C√≥digos criados</div><div class="v" id="kCodes">0</div></div>
        <div class="kpi"><div class="t">Slots liberados (Œ£ slotsAllowed)</div><div class="v" id="kAllowed">0</div></div>
        <div class="kpi"><div class="t">Slots atribu√≠dos (Œ£ slotsAssigned)</div><div class="v" id="kAssigned">0</div></div>
        <div class="kpi"><div class="t">Pool (livres sem c√≥digo)</div><div class="v" id="kPoolFree">‚Äî</div></div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button class="ghost" onclick="refreshAll()">Atualizar tudo</button>
        <button class="g" onclick="openSummary()">Ver Resumo</button>
      </div>
    </div>

    <!-- C√ìDIGOS -->
    <div class="card">
      <div class="cardTitle">C√≥digos</div>
      <div class="sub">Crie c√≥digos e selecione no dropdown para ver/gerir slots vinculados.</div>

      <div class="row" style="margin-top:10px;">
        <div class="field" style="flex:0 0 180px;">
          <label>Minutos do c√≥digo</label>
          <input id="mins" type="number" min="1" value="60">
        </div>
        <div class="field" style="flex:0 0 220px;">
          <label>slotsAllowed</label>
          <input id="slotsAllowed" type="number" min="0" value="3">
        </div>
        <button class="a" onclick="createCode()">Criar c√≥digo</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field">
          <label>C√≥digo gerado (clique para copiar)</label>
          <input id="codeOut" readonly placeholder="(vai aparecer aqui)">
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="field" style="flex:1 1 280px;">
          <label>Selecionar c√≥digo (dropdown)</label>
          <select id="codeSelect">
            <option value="">(carregando...)</option>
          </select>
        </div>
        <button class="g" onclick="loadSlots()">Ver slots do c√≥digo</button>
      </div>

      <div class="sub" style="margin-top:10px;">
        Se o dropdown ficar vazio, clique em ‚ÄúAtualizar tudo‚Äù (senha precisa estar correta).
      </div>
    </div>
  </div>

  <div class="slotsHeader">
    <div>
      <div class="cardTitle" style="margin:0;">Slots</div>
      <div class="hint">Ap√≥s aplicar o Pool, os slots aparecem aqui automaticamente.</div>
    </div>
    <div class="row" style="margin:0;">
      <button class="ghost" onclick="loadSlots()">Atualizar (C√≥digo)</button>
      <button class="ghost" onclick="loadAllSlots()">Atualizar (Todos)</button>
    </div>
  </div>

  <div id="slotsGrid" class="slotsGrid"></div>

  <div class="footer">
    <div>¬© OFF Company</div>
    <div>Desenvolvido por Lucas Santos</div>
  </div>
</div>

<div id="toast" class="toast">‚úÖ</div>

<script>
  // ========= COLE SUA URL /exec AQUI =========
  const API_URL = "https://script.google.com/macros/s/AKfycbyyU0eLff_-CRNBi6G_BfjGZA9G3kEylVHuhM0N9HqNFD2vsR8A2NeF_g0jV921Q4MG/exec";

  let slots = [];
  let allSlotsCache = [];

  function toast(msg){
    const t=document.getElementById("toast");
    t.textContent=msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1700);
  }
  function overlay(on){
    document.getElementById("overlay").style.display = on ? "flex" : "none";
  }
  function adminPass(){ return document.getElementById("adminPass").value || ""; }

  function normalizeCode(s){
    s = String(s||"").trim().toUpperCase();
    const m = s.match(/[A-Z0-9]{4,12}/);
    return m ? m[0] : "";
  }

  function currentCode(){
    return normalizeCode(document.getElementById("codeSelect").value || "");
  }

  async function api(fn, payload){
    const controller = new AbortController();
    const timeout = setTimeout(()=>controller.abort(), 20000);
    try{
      const res = await fetch(API_URL, {
        method:"POST",
        cache:"no-store",
        body: JSON.stringify({ fn, payload }),
        signal: controller.signal
      });
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { return { ok:false, error:"Resposta inv√°lida: " + text.slice(0,160) }; }
    }catch(err){
      return { ok:false, error:(err.name==="AbortError" ? "Timeout (20s)" : String(err)) };
    }finally{
      clearTimeout(timeout);
    }
  }

  // ========= DROPDOWN + KPIs =========
  async function refreshCodes(){
    const pass = adminPass();
    if(!pass){
      // n√£o bloqueia a UI, mas avisa
      fillCodes([]);
      setKpis({totalCodes:0,totalAllowed:0,totalAssigned:0,pool:null});
      return;
    }

    async function wipeAll(){
  const pass = adminPass();
  if(!pass) return toast("Digite a senha admin");

  const poolTotal = Number(document.getElementById("wipePool").value || 0);

  // confirma√ß√£o dupla (evita clique acidental)
  const first = prompt("DIGITE: APAGAR TUDO\n(ir√° apagar VIP e CODES da planilha)");
  if(String(first||"").trim().toUpperCase() !== "APAGAR TUDO"){
    return toast("Cancelado");
  }
  const second = prompt("Confirma novamente? Digite: CONFIRMO");
  if(String(second||"").trim().toUpperCase() !== "CONFIRMO"){
    return toast("Cancelado");
  }

  overlay(true);
  const r = await api("vipAdminWipeAll", { adminPass: pass, poolTotal });
  overlay(false);

  if(!r.ok) return toast("‚ùå " + r.error);

  toast("‚úÖ Reset total feito");
  // atualiza UI
  await refreshCodes();
  // se voc√™ tem fun√ß√£o loadSlots(), tenta atualizar a grade
  if(typeof loadSlots === "function"){
    try{ await loadSlots(); }catch(e){}
  }
}

    const r = await api("vipAdminListCodes", { adminPass: pass });
    if(!r.ok){
      fillCodes([]);
      toast("‚ùå " + r.error);
      return;
    }

    const rows = r.rows || [];
    fillCodes(rows);

    // KPIs de c√≥digos
    setKpis({
      totalCodes: rows.length,
      totalAllowed: r.totalAllowed ?? rows.reduce((a,x)=>a+(Number(x.slotsAllowed)||0),0),
      totalAssigned: r.totalAssigned ?? rows.reduce((a,x)=>a+(Number(x.slotsAssigned)||0),0),
    });
  }

  function fillCodes(rows){
    const sel = document.getElementById("codeSelect");
    const keep = sel.value;

    if(!rows || !rows.length){
      sel.innerHTML = `<option value="">(nenhum c√≥digo)</option>`;
      return;
    }

    sel.innerHTML = rows.map(x=>{
      const code = String(x.code||"").trim();
      const allowed = Number(x.slotsAllowed||0);
      const assigned = Number(x.slotsAssigned||0);
      const expired = !!x.expired;
      const active = (x.isActive !== false);
      return `<option value="${code}">${code} ‚Ä¢ allowed:${allowed} ‚Ä¢ assigned:${assigned}${expired?" ‚Ä¢ EXPIRADO":""}${!active?" ‚Ä¢ OFF":""}</option>`;
    }).join("");

    if(keep) sel.value = keep;
  }

  function setKpis({totalCodes, totalAllowed, totalAssigned, pool}){
    document.getElementById("kCodes").textContent = String(totalCodes ?? 0);
    document.getElementById("kAllowed").textContent = String(totalAllowed ?? 0);
    document.getElementById("kAssigned").textContent = String(totalAssigned ?? 0);
    document.getElementById("kPoolFree").textContent = (pool==null ? "‚Äî" : String(pool));
  }

  // ========= POOL =========
  async function setPool(){
    const pass = adminPass();
    if(!pass) return toast("Digite a senha admin");

    const total = Number(document.getElementById("poolTotal").value||0);

    overlay(true);
    const r = await api("vipAdminSetGlobalSlotCount", { adminPass: pass, total });
    overlay(false);

    if(!r.ok) return toast("‚ùå " + r.error);

    toast("‚úÖ Pool aplicado");

    // ‚úÖ ap√≥s criar pool: atualizar tudo + mostrar slots embaixo
    await refreshAll();
    await loadAllSlots(); // mostra geral automaticamente
  }

  // ========= CRIAR C√ìDIGO =========
  async function createCode(){
    const pass = adminPass();
    if(!pass) return toast("Digite a senha admin");

    const minutes = Number(document.getElementById("mins").value||60);
    const slotsAllowed = Number(document.getElementById("slotsAllowed").value||0);

    overlay(true);
    const r = await api("vipAdminCreateTempCode", { adminPass: pass, minutes, slotsAllowed });
    overlay(false);

    if(!r.ok) return toast("‚ùå " + r.error);

    const out = document.getElementById("codeOut");
    out.value = `${r.code} (allowed ${r.slotsAllowed}, expira ${new Date(r.expiresAt).toLocaleString("pt-BR")})`;
    toast("‚úÖ C√≥digo criado");

    await refreshCodes();

    // seleciona o novo c√≥digo no dropdown (se existir)
    const sel = document.getElementById("codeSelect");
    if(sel){
      sel.value = r.code;
    }
    // e carrega os slots vinculados (se tiver)
    await loadSlots(true);
  }

  document.getElementById("codeOut").addEventListener("click", async ()=>{
    const v = document.getElementById("codeOut").value || "";
    const code = normalizeCode(v);
    if(!code) return;
    try{
      await navigator.clipboard.writeText(code);
      toast("üìã Copiado: " + code);
    }catch{ toast("‚ùå N√£o deu pra copiar"); }
  });

  // ========= LOAD SLOTS =========
  async function loadSlots(silent=false){
    const pass = adminPass();
    if(!pass) return toast("Digite a senha admin");

    const code = currentCode();
    if(!code){
      if(!silent) toast("Selecione um c√≥digo");
      return;
    }

    overlay(true);
    const r = await api("vipAdminCodeInfo", { adminPass: pass, code });
    overlay(false);

    if(!r.ok) return toast("‚ùå " + r.error);

    slots = r.slots || [];
    renderSlots(slots, { title: `Slots do c√≥digo ${code}`, codeMode:true });

    if(!silent) toast("‚úÖ Slots do c√≥digo carregados");
  }

  async function loadAllSlots(){
    const pass = adminPass();
    if(!pass) return toast("Digite a senha admin");

    overlay(true);
    const r = await api("vipAdminGet", { adminPass: pass });
    overlay(false);

    if(!r.ok) return toast("‚ùå " + r.error);

    allSlotsCache = r.rows || [];
    renderSlots(allSlotsCache, { title:"Todos os slots", codeMode:false });

    // pool info (livres sem c√≥digo)
    const poolFree = allSlotsCache.filter(x => !String(x.code||"").trim() && String(x.status||"").toUpperCase()==="LIVRE").length;
    // mant√©m KPIs e atualiza pool livre
    const kCodes = Number(document.getElementById("kCodes").textContent||0);
    const kAllowed = Number(document.getElementById("kAllowed").textContent||0);
    const kAssigned = Number(document.getElementById("kAssigned").textContent||0);
    setKpis({ totalCodes:kCodes, totalAllowed:kAllowed, totalAssigned:kAssigned, pool: poolFree });

    toast("‚úÖ Slots (geral) atualizados");
  }

  async function refreshAll(){
    await refreshCodes();
    // tamb√©m tenta atualizar pool info + slots geral (se a senha existir)
    if(adminPass()) await loadAllSlots();
  }

  // ========= RESUMO (MODAL) =========
  function openSummary(){
    if(!allSlotsCache || !allSlotsCache.length){
      // tenta carregar geral antes
      loadAllSlots().then(()=>openSummary());
      return;
    }

    const total = allSlotsCache.length;
    const free = allSlotsCache.filter(x => String(x.status||"").toUpperCase()==="LIVRE").length;
    const conf = allSlotsCache.filter(x => String(x.status||"").toUpperCase()==="CONFIRMADO" || x.confirmed===true).length;
    const taken = allSlotsCache.filter(x => {
      const st = String(x.status||"").toUpperCase();
      return st==="OCUPADO" || st==="CONFIRMADO" || x.confirmed===true;
    }).length;

    document.getElementById("mTotal").textContent = String(total);
    document.getElementById("mFree").textContent = String(free);
    document.getElementById("mTaken").textContent = String(taken);
    document.getElementById("mConf").textContent = String(conf);

    const rows = allSlotsCache
      .filter(x => {
        const st = String(x.status||"").toUpperCase();
        return st==="OCUPADO" || st==="CONFIRMADO" || x.confirmed===true;
      })
      .slice(0, 200); // seguran√ßa

    const tbody = document.getElementById("mRows");
    tbody.innerHTML = rows.length ? rows.map(x=>{
      const st = String(x.status||"").toUpperCase();
      const statusTxt = (st==="CONFIRMADO" || x.confirmed===true) ? "‚úÖ CONFIRMADO" : "‚ö†Ô∏è OCUPADO";
      const code = String(x.code||"").trim();
      return `
        <tr>
          <td><b>#${esc(x.slot)}</b></td>
          <td>${esc(statusTxt)}</td>
          <td>${esc(x.nome||"‚Äî")}</td>
          <td>${code ? `<span class="chip chipPurple">#${esc(code)}</span>` : "‚Äî"}</td>
        </tr>
      `;
    }).join("") : `<tr><td colspan="4" style="color:rgba(229,231,235,.6)">Nenhum slot ocupado.</td></tr>`;

    document.getElementById("summaryModal").style.display="flex";
  }

  function closeSummary(){
    document.getElementById("summaryModal").style.display="none";
  }

  // ========= RENDER =========
  function renderSlots(list, {title, codeMode}){
    const grid = document.getElementById("slotsGrid");

    if(!list || !list.length){
      grid.innerHTML = `
        <div class="card" style="grid-column:1/-1">
          <b>${esc(title || "Slots")}: vazio.</b>
          <div class="sub" style="margin-top:6px">Crie o Pool e/ou selecione um c√≥digo.</div>
        </div>`;
      return;
    }

    grid.innerHTML = list.map(s=>{
      const rawStatus = String(s.status||"LIVRE").toUpperCase();
      const confirmed = (rawStatus==="CONFIRMADO") || (s.confirmed===true) || (String(s.confirmed||"").toUpperCase()==="TRUE");
      const status = confirmed ? "CONFIRMADO" : rawStatus;

      const cls =
        status==="LIVRE" ? "bLivre" :
        status==="BLOQUEADO" ? "bBloq" :
        status==="CONFIRMADO" ? "bConf" : "bOcup";

      const badge =
        status==="LIVRE" ? "Livre" :
        status==="BLOQUEADO" ? "Bloqueado" :
        status==="CONFIRMADO" ? "Confirmado" : "Ocupado";

      const line1 = (status==="LIVRE" || status==="BLOQUEADO")
        ? `<div class="info muted">‚Äî</div>`
        : `<div class="info"><b>${esc(s.nome||"")}</b><br><span class="muted">RG:</span> ${esc(s.rg||"")} <span class="muted">CPF:</span> ${esc(s.cpf||"")}</div>`;

      const line2 = (status==="LIVRE" || status==="BLOQUEADO") ? "" :
        `<div class="info muted">Ve√≠culo: ${esc(s.veiculo||"NAO")} ‚Ä¢ Placa: ${esc(s.placa||"")} ‚Ä¢ ${esc(s.cor||"")} ‚Ä¢ ${esc(s.modelo||"")}</div>`;

      const codeTag = (String(s.code||"").trim())
        ? `<div class="info muted">C√≥digo: <b>#${esc(s.code)}</b></div>`
        : `<div class="info muted">C√≥digo: <span class="muted">‚Äî (Pool)</span></div>`;

      const showActions = (status!=="BLOQUEADO"); // simples

      return `
        <div class="slot ${cls}">
          <div>
            <div class="topRow">
              <div class="num">#${esc(s.slot)}</div>
              <div class="badge">${badge}</div>
            </div>
            ${line1}
            ${line2}
            ${codeTag}
          </div>

          <div class="miniActions">
            ${showActions ? `
              <button class="miniBtn miniBlue" onclick="clearSlot('${escJS(s.slot)}')">üßπ</button>
              <button class="miniBtn miniGreen" onclick="confirmSlot('${escJS(s.slot)}')">‚úÖ</button>
              <button class="miniBtn miniRed" onclick="blockToggle('${escJS(s.slot)}')">‚õî</button>
            ` : `
              <button class="miniBtn miniBlue" onclick="blockToggle('${escJS(s.slot)}')">üîì</button>
              <button class="miniBtn miniRed" onclick="clearSlot('${escJS(s.slot)}')">üßπ</button>
              <button class="miniBtn miniGreen" onclick="confirmSlot('${escJS(s.slot)}')">‚úÖ</button>
            `}
          </div>
        </div>
      `;
    }).join("");
  }

  // ========= ACTIONS =========
  async function clearSlot(slotId){
    const pass = adminPass();
    if(!pass) return toast("Digite a senha admin");
    overlay(true);
    const r = await api("vipAdminClearSlot", { adminPass: pass, slotId });
    overlay(false);
    if(!r.ok) return toast("‚ùå " + r.error);
    toast("‚úÖ Slot limpo");
    await loadAllSlots();
  }

  async function confirmSlot(slotId){
    const pass = adminPass();
    if(!pass) return toast("Digite a senha admin");
    overlay(true);
    const r = await api("vipAdminConfirmSlot", { adminPass: pass, slotId });
    overlay(false);
    if(!r.ok) return toast("‚ùå " + r.error);
    toast("‚úÖ Confirmado (toggle)");
    await loadAllSlots();
  }

  async function blockToggle(slotId){
    const pass = adminPass();
    if(!pass) return toast("Digite a senha admin");
    overlay(true);
    const r = await api("vipAdminToggleBlock", { adminPass: pass, slotId });
    overlay(false);
    if(!r.ok) return toast("‚ùå " + r.error);
    toast("‚úÖ Alterado");
    await loadAllSlots();
  }

  // ========= UTIL =========
  function esc(s){
    return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function escJS(s){
    return String(s??"").replace(/['\\]/g, "\\$&");
  }

  // fecha resumo clicando fora
  document.getElementById("summaryModal").addEventListener("click", (e)=>{
    if(e.target && e.target.id==="summaryModal") closeSummary();
  });

  // ‚úÖ auto-carregar dropdown (quando abre)
  window.addEventListener("DOMContentLoaded", ()=>{
    // n√£o tenta chamar API sem senha, mas deixa pronto:
    fillCodes([]);
    setKpis({totalCodes:0,totalAllowed:0,totalAssigned:0,pool:null});

    // melhoria: quando o admin digita a senha, j√° atualiza dropdown + slots
    const passEl = document.getElementById("adminPass");
    let t=null;
    passEl.addEventListener("input", ()=>{
      clearTimeout(t);
      t=setTimeout(()=> refreshAll(), 450);
    });
  });
</script>
</body>
</html>
